# 함수

## 즉시 실행 함수

즉시 실행 함수 패턴은 함수가 선언되자마자 실행되도록 하는 문법이다. 다음 예제를 보자.

```javascript
(function() {
  console.log('watch out!');
}());
```

이 패턴은 사실상 (기명이든 무명이든) 함수 표현식을, 생성한 직후 실행시킨다. 즉시 실행 함수라는 용어는 ECMAScript 표준에서 정의된 용어가 아니지만, 짧고 간단하며 이 패턴을 설명하고 논의하는 데 유용하다. 즉시 실행 함수 패턴은 다음의 부분들로 구성된다.

  * 함수를 함수 표현식으로 선언한다. (함수 선언문으로는 동작하지 않는다.)
  * 함수가 즉시 실행될 수 있도록 마지막에 괄호쌍을 추가한다.
  * 전체 함수를 괄호로 감싼다. (함수를 변수에 할당하지 않을 경우에만 필요하다.)

다음의 대체 문법 또한 일반적으로 사용되지만 JSLint는 처음의 패턴을 선호한다. *닫는 괄호의 위치에 주의하라*
```javascript
(function() {
  console.log('watch out!');
})();
```

이 패턴은 초기화 코드에 유효범위 샌드박스를 제공한다는 점에서 유용하다. 다음의 일반적인 시나리오를 생각해보자. 페이지 로드가 완료된 후 이벤트 핸들러를 등록하거나 객체를 생성하는 등의 초기 설정 작업을 해야 한다. 이 모든 작업은 단 한 번만 실행되기 때문에 재사용하기 위해 이름이 지정된 함수를 생성할 필요가 없다. 하지만, 한편으로는 초기화 단계가 완료될 때까지만 사용할 임시 변수들이 필요하다. 이 모든 변수를 전역으로 생성하는 것은 좋지 않은 생각이다. 이럴 떄 즉시 실행 함수가 필요하다. 즉시 실행 함수는 모든 코드를 지역 유효범위로 감싸고 어떤 변수도 전역 유효 범위로 새어나가지 않게 한다. 

```javascript
(function () {
  var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
      today = new Date(),
      msg = 'Today is ' + days[today.getDay()]  + ', ' + today.getDate();

  console.log(msg)

})(); // 'Today is Fri, 13'
```

만약 이 코드가 즉시 실행 함수로 감싸져 있지 않았다면, days, today, msg 변수는 전역 변수가 되어 초기화 코드 이후에도 남아 있게 될 것이다. 

## 즉시 실행 함수의 매개 변수

즉시 실행 함수에 인자를 전달할 수도 있다. 다음 예제를 보자

```javascript
// 출력 결과:
// I met Joe Black on Fri Aug 13 2010 23:26:59 GMT-0900 (PST)

(function (who, when) {
  console.log("I met " + who + " on " + when)
})("Joe Black", new Date()));
```

일반적으로 전역 객체가 즉시 실행 함수의 인자로 전달된다. 따라서 즉시 실행 함수 내에서 window를 사용하지 않고도 전역 객체에 접근할 수 있다. 이러한 방법을 통해 브라우저 외의 실행 환경에서도 코드를 공통으로 사용할 수 있다. 

```javascript
(function (global) {
  // 전역 객체를 'global'로 참조
  }(this));
```

일반적으로는 즉시 실행 함수에 대한 인자를 너무 많이 전달하지 않는 것이 좋다. 코드의 동작을 이해하려고 계속해서 코드의 맨 윗부분과 아랫부분 사이를 오가며 스크롤 하기가 부담스럽기 때문이다.


## 즉시 실행 함수의 반환 값

다른 함수와 비슷하게, 즉시 실행 함수도 값을 반환할 수 있고 반환된 값은 변수에 할당될 수 있다.

```javascript
var result = (function () {
  return 2 + 2;
}());
```

감싸고 있는 괄호를 생략해서 같은 동작을 구현할 수 있다. 즉시 실행 함수의 반환 값을 변수에 할당할 떄는 괄호가 필요 없기 때문이다. 첫 번째 괄호쌍을 생략하면 다음과 같은 형태가 된다. 

```javascript
var result = function () {
  return 2 + 2;
}();
```

이 문법이 더 간단하지만 약간 오해의 소지가 있다. 누군가 코드를 읽을 때 마지막의 ()를 눈여겨보지 못한다면 이 구문의 결과가 함수를 참조한다고 생각할 수 있다. 사실 결과 값은 즉시 실행 함수의 반환 값, 즉 이 경우에는 숫자 4를 참조한다. 동일한 결과를 갖는 또 다른 문법은 다음과 같다. 

```javascript
var result = (function () {
  return 2 + 2;
})();
```

이 예제는 즉시 실행 함수의 실행 결과로 원시 데이터 타입인 정수 값을 반환한다. 원시 데이터 값 외에도 모든 타입의 값이 가능하고, 새로운 함수를 반환할 수도 있다. 이 경우 즉시 실행 함수의 유효범위를 사용해 특정 데이터를 비공개 상태로 저장하고, 반환되는 내부 함수에서만 접근하도록 할 수도 있다.

다음 예제를 보면, 즉시 실행 함수가 함수를 반환하고 이 반환값이 `getResult`라는 변수에 할당된다. 이 함수는 즉시 실행 함수에서 미리 계산하여 클로저에 저장해둔 res라는 값을 반환한다. 

```javascript
var getResult = (function() {
  var rest = 2 + 2;
  return function () {
    return res;
  }
}());
```

즉시 실행 함수는 객체 프로퍼티를 정의할 때에도 사용할 수 있다. 어떤 객체의 프로퍼티가 객체의 생명주기 동안에는 값이 변하지 않고, 처음에 값을 정의할 때는 적절한 계산을 위한 작업이 필요하다고 가정해보자. 그렇다면 이 작업을 즉시 실행 함수로 감싼 후, 즉시 실행 함수의 반환 값을 프로퍼티 값으로 할당하면 된다. 다음의 코드 예제를 살펴보자. 

```javascript
var o = {
  message: (function() {
    var who = "me",
    what = "call";
    return what + " " + who;
  }()),
  getMsg: function () {
    return this.message;
  }
};
// 사용 방법
o.getMsg // "call me"
o.message // "call me"
```

이 예제에서, o.message는 함수가 아닌 문자열 프로퍼티이지만 값을 정의하려면 함수가 필요하다. 이 함수는 스크립트가 로딩될 때 실행되어 프로퍼티를 정의한다.

## 장점과 사용 방법
즉시 실행 함수 패턴은 폭넓게 사용된다. 전역 변수를 남기지 않고 상당량의 작업을 할 수 있게 해준다. 선언된 모든 변수는 스스로를 호출하는(self-invoking) 함수의 지역 변수가 되기 떄문에 임시 변수가 전역 공간을 어지럽힐까봐 걱정하지 않아도 된다.
이 패턴은 북마클릿(bookmarklet)에서도 자주 쓰인다. 북마클릿은 어떤 페이지에서도 실행될 수 있고 전역 네임스페이스를 깨끗하게 유지하면서 무간섭적인 상태로 유지하는 것이 매우 중요하기 때문이다.
즉시 실행 함수 패턴을 사용해 개별 기능을 독자적인 모듈로 감쌀 수도 있다. 페이지가 정적이고 자바스크립트 없이도 잘 동작한다고 상상해보자. 점진적인 개선이 코드를 즉시 실행 함수로 감싸고 페이지에 추가된 코드가 있을 때와 없을 때 잘 동작하는지 확인한다. 그러고 나서 더 많은 개선 사항을 추가하거나 제거할 수도 있고 개별로 테스트할 수도 있으며, 사용자가 비활성화할 수 있게 하는 등의 작업을 할 수 있다.
다음 템플릿을 활용하면 기능을 단위별로 정의할 수 있다. 이것을 module1이라고 부르자.

```javascript
// module1.js에서 정의한 moduel1
(function() {
  // 모든 module1 코드...
}());
```

이 템플릿을 따라 또 다른 모듈도 코딩할 수 있다. 그리고 실제 사이트에 코드를 올릴 때, 어떠 ㄴ기능이 사용될 준비가 되었는지 결정하고 빌드 스크립트를 사용해 해당하는 파일들을 병합하면 된다.
